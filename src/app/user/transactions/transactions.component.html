<app-sidebar></app-sidebar>

<!-- Main Content Container -->
<div class="ml-64 p-6 mt-16 bg-gray-100 min-h-screen">
  <h2 class="text-3xl font-semibold mb-6">My Transaction History</h2>

  <!-- Outer Card -->
  <div class="bg-white shadow rounded-lg p-6">

    <!-- Error Message -->
    <div *ngIf="errorMessage" class="mb-4 p-4 bg-red-100 text-red-700 rounded">
      {{ errorMessage }}
    </div>

    <!-- Success Message -->
    <div *ngIf="successMessage" class="mb-4 p-4 bg-green-100 text-green-700 rounded">
      {{ successMessage }}
    </div>

    <!-- Loading Spinner -->
    <div *ngIf="isLoading" class="flex justify-center mt-4">
      <div class="loader"></div>
    </div>

    <!-- Account Selection Dropdown -->
    <div *ngIf="!isLoading && accounts.length > 0 && !selectedAccountId" class="mb-6">
      <label for="accountSelect" class="block text-sm font-medium text-gray-700">Select an Account to View Transactions:</label>
      <select id="accountSelect" [(ngModel)]="selectedAccountId" (change)="onAccountSelect(selectedAccountId)" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
        <option value="" disabled selected>Select an account</option>
        <option *ngFor="let account of accounts" [value]="account.id">
          {{ getAccountType(account) }} - {{ account.accountNumber }}
        </option>
      </select>
    </div>

    <!-- Prompt to Select an Account -->
    <div *ngIf="!isLoading && !selectedAccountId" class="text-gray-500 text-sm mt-4">
      Please select an account from the dropdown above to view its transactions.
    </div>

    <!-- Transactions and Scheduled Transfers Tables -->
    <div *ngIf="!isLoading && selectedAccountId">

      <!-- Transactions Table -->
      <div *ngIf="transactions.length > 0" class="mb-8">
        <h3 class="text-2xl font-semibold mb-4">Transactions</h3>
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Other Party</th>
          </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
          <tr *ngFor="let tx of transactions">
            <td class="px-6 py-4 whitespace-nowrap">{{ tx.date | date:'short' }}</td>
            <td class="px-6 py-4 whitespace-nowrap">{{ tx.amount + " DH" }}</td>
            <td class="px-6 py-4 whitespace-nowrap">{{ tx.type }}</td>
            <td class="px-6 py-4 whitespace-nowrap">
              <!-- Status Badges -->
              <span
                *ngIf="tx.status === 'APPROVED'"
                class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800"
              >
                  {{ tx.status }}
                </span>
              <span
                *ngIf="tx.status === 'PENDING'"
                class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800"
              >
                  {{ tx.status }}
                </span>
              <span
                *ngIf="tx.status !== 'APPROVED' && tx.status !== 'PENDING'"
                class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800"
              >
                  {{ tx.status }}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">{{ tx.otherPartyUsername }}</td>
          </tr>
          </tbody>
        </table>
      </div>

      <!-- No Transactions Message -->
      <div *ngIf="!isLoading && selectedAccountId && transactions.length === 0" class="text-gray-500 text-sm mt-4">
        No transactions found for this account.
      </div>

      <!-- Scheduled Transfers Table -->
      <div *ngIf="scheduledTransfers.length > 0" class="mb-8">
        <h3 class="text-2xl font-semibold mb-4">Scheduled Transfers</h3>
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Next Execution Date</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Frequency</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">From Account</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">To Account</th>
          </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
          <tr *ngFor="let st of scheduledTransfers">
            <td class="px-6 py-4 whitespace-nowrap">{{ st.nextExecutionDate | date:'short' }}</td>
            <td class="px-6 py-4 whitespace-nowrap">{{ st.amount + " DH" }}</td>
            <td class="px-6 py-4 whitespace-nowrap">{{ st.frequency }}</td>
            <td class="px-6 py-4 whitespace-nowrap">{{ st.fromAccountNumber }}</td>
            <td class="px-6 py-4 whitespace-nowrap">{{ st.toAccountNumber }}</td>
          </tr>
          </tbody>
        </table>
      </div>

      <!-- No Scheduled Transfers Message -->
      <div *ngIf="!isLoading && selectedAccountId && scheduledTransfers.length === 0" class="text-gray-500 text-sm mt-4">
        No scheduled transfers found for this account.
      </div>

      <!-- Pagination Controls -->
      <div class="flex justify-center items-center mt-6 space-x-4" *ngIf="(transactions.length > 0 || scheduledTransfers.length > 0)">
        <button
          (click)="goToPreviousPage()"
          [disabled]="currentPage === 0 || isLoading"
          class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 disabled:opacity-50"
        >
          Previous
        </button>
        <span class="px-4 py-2">Page {{ currentPage + 1 }}</span>
        <button
          (click)="goToNextPage()"
          [disabled]="(!hasMoreTransactions && !hasMoreScheduled) || isLoading"
          class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 disabled:opacity-50"
        >
          Next
        </button>
      </div>

    </div>

  </div> <!-- end bg-white card -->

</div> <!-- end main content -->
